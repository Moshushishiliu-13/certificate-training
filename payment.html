<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程报名支付 - 职场人加油站</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">职场人加油站</h1>
                    <p class="mt-1 text-sm text-gray-600">课程报名支付</p>
                </div>
                <div class="flex space-x-4">
                    <a href="courses.html" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        返回课程列表
                    </a>
                    <a href="index.html" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                        返回首页
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6">
                <h2 class="text-lg leading-6 font-medium text-gray-900" id="course-title">课程报名</h2>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">请确认课程信息并完成支付</p>
            </div>
            <div class="border-t border-gray-200">
                <dl>
                    <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                        <dt class="text-sm font-medium text-gray-500">课程名称</dt>
                        <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="course-name">--</dd>
                    </div>
                    <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                        <dt class="text-sm font-medium text-gray-500">课程价格</dt>
                        <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="course-price">--</dd>
                    </div>
                    <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                        <dt class="text-sm font-medium text-gray-500">课程周期</dt>
                        <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="course-duration">--</dd>
                    </div>
                    <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                        <dt class="text-sm font-medium text-gray-500">证书类型</dt>
                        <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2" id="course-certificate">--</dd>
                    </div>
                </dl>
            </div>
        </div>

        <div class="mt-10 bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900">个人信息</h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">请填写您的联系信息</p>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <form id="payment-form">
                    <div class="grid grid-cols-6 gap-6">
                        <div class="col-span-6 sm:col-span-3">
                            <label for="first-name" class="block text-sm font-medium text-gray-700">姓名</label>
                            <input type="text" name="first-name" id="first-name" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>

                        <div class="col-span-6 sm:col-span-3">
                            <label for="phone" class="block text-sm font-medium text-gray-700">手机号码</label>
                            <input type="text" name="phone" id="phone" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>

                        <div class="col-span-6 sm:col-span-4">
                            <label for="email" class="block text-sm font-medium text-gray-700">电子邮箱</label>
                            <input type="text" name="email" id="email" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>

                        <div class="col-span-6 sm:col-span-3">
                            <label for="company" class="block text-sm font-medium text-gray-700">公司/单位</label>
                            <input type="text" name="company" id="company" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>

                        <div class="col-span-6 sm:col-span-3">
                            <label for="position" class="block text-sm font-medium text-gray-700">职位</label>
                            <input type="text" name="position" id="position" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>

                        <div class="col-span-6">
                            <label for="remarks" class="block text-sm font-medium text-gray-700">备注</label>
                            <textarea id="remarks" name="remarks" rows="3" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"></textarea>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-10 bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900">支付方式</h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">请选择您的支付方式</p>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="flex space-x-4">
                    <div class="flex items-center">
                        <input id="payment-wechat" name="payment-method" type="radio" checked class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                        <label for="payment-wechat" class="ml-3 block text-sm font-medium text-gray-700">
                            微信支付
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input id="payment-alipay" name="payment-method" type="radio" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                        <label for="payment-alipay" class="ml-3 block text-sm font-medium text-gray-700">
                            支付宝
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input id="payment-bank" name="payment-method" type="radio" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                        <label for="payment-bank" class="ml-3 block text-sm font-medium text-gray-700">
                            银行转账
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-10 flex justify-end">
            <button type="button" class="mr-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="submit-payment">
                确认支付
            </button>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between">
                <div class="mb-6 md:mb-0">
                    <h2 class="text-lg font-semibold mb-4">职场人加油站</h2>
                    <p class="text-gray-300 text-sm">专业认证培训，助力您的职业成长</p>
                </div>
                <div class="grid grid-cols-2 gap-8 sm:grid-cols-3">
                    <div>
                        <h3 class="text-base font-medium mb-3">关于我们</h3>
                        <ul class="text-sm space-y-2">
                            <li><a href="#" class="text-gray-300 hover:text-white">公司简介</a></li>
                            <li><a href="#" class="text-gray-300 hover:text-white">讲师团队</a></li>
                            <li><a href="#" class="text-gray-300 hover:text-white">联系方式</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-base font-medium mb-3">培训服务</h3>
                        <ul class="text-sm space-y-2">
                            <li><a href="#" class="text-gray-300 hover:text-white">企业内训</a></li>
                            <li><a href="#" class="text-gray-300 hover:text-white">公开课程</a></li>
                            <li><a href="#" class="text-gray-300 hover:text-white">在线学习</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-base font-medium mb-3">帮助中心</h3>
                        <ul class="text-sm space-y-2">
                            <li><a href="#" class="text-gray-300 hover:text-white">常见问题</a></li>
                            <li><a href="#" class="text-gray-300 hover:text-white">报名流程</a></li>
                            <li><a href="#" class="text-gray-300 hover:text-white">学习指南</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-gray-700 text-sm text-gray-400">
                <p>© 2025 职场人加油站. 保留所有权利.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('course');
            
            // 课程数据库
            const courses = {
                'iso9001': {
                    name: 'ISO 9001质量管理体系内审员培训',
                    price: '￥198',
                    duration: '约14天',
                    certificate: '内审员培训证书'
                },
                'iatf16949': {
                    name: 'IATF 16949汽车行业质量管理体系内审员培训',
                    price: '￥398',
                    duration: '约14天',
                    certificate: '内审员培训证书'
                },
                'iso14001-45001': {
                    name: 'ISO 14001 & 45001内审员培训',
                    price: '￥198',
                    duration: '约14天',
                    certificate: '内审员培训证书'
                },
                'iso13485': {
                    name: 'ISO 13485医疗器械质量管理体系内审员培训',
                    price: '￥198',
                    duration: '约14天',
                    certificate: '内审员培训证书'
                },
                'iso9001-advanced': {
                    name: 'ISO 9001质量管理体系审核技术进阶课程',
                    price: '￥399',
                    duration: '约14天',
                    certificate: '课程培训证书'
                },
                'iatf-planning': {
                    name: 'IATF体系文件策划与关键过程管理训练营',
                    price: '￥499',
                    duration: '约14天',
                    certificate: '课程培训证书'
                },
                'iso9001-doc': {
                    name: 'ISO9001质量管理体系文件策划与编写指导',
                    price: '￥299',
                    duration: '约18天',
                    certificate: '课程培训证书'
                },
                'qc-tools': {
                    name: '基于问题解决的QC七大手法工具应用',
                    price: '￥198',
                    duration: '约14天',
                    certificate: '课程培训证书'
                },
                '8d': {
                    name: '8D精讲与案例实操',
                    price: '￥198',
                    duration: '约7天',
                    certificate: '课程培训证书'
                },
                'apqp-ppap': {
                    name: '质量管理核心工具训练营（APQP/PPAP)',
                    price: '￥499',
                    duration: '约20天',
                    certificate: '课程培训证书'
                },
                'fmea': {
                    name: '质量管理核心工具训练营（FMEA)',
                    price: '￥299',
                    duration: '约20天',
                    certificate: '课程培训证书'
                },
                'spc-msa': {
                    name: '质量管理核心工具训练营（SPC/MSA)',
                    price: '￥399',
                    duration: '约20天',
                    certificate: '课程培训证书'
                },
                'cp': {
                    name: '质量管理核心工具训练营（CP)',
                    price: '￥299',
                    duration: '约20天',
                    certificate: '课程培训证书'
                },
                'vda-6-3': {
                    name: 'VDA 6.3:2023 过程审核标准精讲与应用课程',
                    price: '￥299',
                    duration: '约14天',
                    certificate: '课程培训证书'
                },
                'lean-six-sigma-yellow': {
                    name: '精益六西格玛黄带',
                    price: '￥398',
                    duration: '约14天',
                    certificate: '课程培训证书'
                },
                'lean-six-sigma-green': {
                    name: '精益六西格玛绿带',
                    price: '￥2,399',
                    duration: '约60天',
                    certificate: '课程培训证书'
                },
                'lean-six-sigma-black': {
                    name: '精益六西格玛黑带',
                    price: '￥3,999',
                    duration: '约60天',
                    certificate: '课程培训证书'
                },
                'pmp': {
                    name: 'PMP认证考试培训直播课',
                    price: '￥3,180',
                    duration: '2年有效',
                    certificate: '证书考试培训'
                },
                'info-sys-pm': {
                    name: '国考信息系统项目管理师线上直播班',
                    price: '￥3,480',
                    duration: '2年有效',
                    certificate: '证书考试培训'
                },
                'esg-online': {
                    name: 'ESG启航计划线上课程',
                    price: '￥2,500',
                    duration: '约20天',
                    certificate: '证书考试培训'
                },
                'gri-2021': {
                    name: 'GRI可持续发展报告指南（2021版）认证课程',
                    price: '￥3,000',
                    duration: '约20天',
                    certificate: '证书考试培训'
                },
                'esg-offline': {
                    name: 'ESG优才理论与实践年度线下培训',
                    price: '￥14,800',
                    duration: '1年',
                    certificate: '证书考试培训'
                },
                'national-auditor': {
                    name: '国家注册审核员训练营',
                    price: '¥599/科目',
                    duration: '不限时',
                    certificate: '证书考试培训'
                }
            };
            
            // 填充课程信息
            if (courseId && courses[courseId]) {
                const course = courses[courseId];
                document.getElementById('course-title').innerText = '课程报名 - ' + course.name;
                document.getElementById('course-name').innerText = course.name;
                document.getElementById('course-price').innerText = course.price;
                document.getElementById('course-duration').innerText = course.duration;
                document.getElementById('course-certificate').innerText = course.certificate;
                document.title = '课程报名: ' + course.name + ' - 职场人加油站';
            } else {
                // 默认显示或错误处理
                document.getElementById('course-title').innerText = '课程信息未找到';
                document.getElementById('course-name').innerText = '未知课程';
                document.getElementById('course-price').innerText = '--';
                document.getElementById('course-duration').innerText = '--';
                document.getElementById('course-certificate').innerText = '--';
            }
            
            /**
             * @description 支付宝支付功能实现
             */
            function initAlipay() {
                // 支付宝支付相关变量
                const appId = '2021000000000000'; // 请替换为实际的支付宝应用ID
                let orderId = 'ORDER_' + Date.now(); // 生成订单号
                let totalAmount = 0; // 订单金额

                // 获取当前课程价格
                if(courseId && courses[courseId]) {
                    const priceText = courses[courseId].price;
                    // 从价格文本中提取数字部分
                    const priceMatch = priceText.match(/\d+(?:,\d+)?/g);
                    if(priceMatch && priceMatch.length > 0) {
                        totalAmount = parseFloat(priceMatch[0].replace(',', ''));
                    }
                }

                // 支付宝选项按钮点击处理
                document.getElementById('payment-alipay').addEventListener('change', function() {
                    if(this.checked) {
                        // 显示支付宝扫码区域
                        const paymentMethodsDiv = document.querySelector('.px-4.py-5.sm\\:p-6');
                        
                        // 如果已存在支付详情区域，则先移除
                        const existingDetails = document.getElementById('payment-details');
                        if(existingDetails) {
                            existingDetails.remove();
                        }
                        
                        // 创建支付宝支付详情区域
                        const alipayDetails = document.createElement('div');
                        alipayDetails.id = 'payment-details';
                        alipayDetails.className = 'mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50';
                        alipayDetails.innerHTML = `
                            <h4 class="text-sm font-medium text-gray-700 mb-3">支付宝支付</h4>
                            <div class="flex flex-col items-center justify-center">
                                <div id="alipay-qrcode" class="border border-gray-300 p-4 bg-white rounded">
                                    <img src="https://gw.alipayobjects.com/zos/rmsportal/eNlFytEEYPVfPTmEWuXa.png" alt="支付宝示例二维码" class="w-48 h-48">
                                </div>
                                <p class="mt-3 text-sm text-gray-600">请使用支付宝扫描二维码完成支付</p>
                                <p class="mt-1 text-sm text-gray-500">订单号: ${orderId}</p>
                                <p class="mt-1 text-lg font-bold text-indigo-600">金额: ￥${totalAmount.toFixed(2)}</p>
                            </div>
                        `;
                        
                        paymentMethodsDiv.appendChild(alipayDetails);
                    } else {
                        // 移除支付宝支付详情
                        const alipayDetails = document.getElementById('payment-details');
                        if(alipayDetails) {
                            alipayDetails.remove();
                        }
                    }
                });
            }

            /**
             * @description 实际生成支付宝订单的函数
             * @param {string} orderInfo - 订单信息
             * @returns {Promise} - 返回包含支付链接的Promise
             */
            function createAlipayOrder(orderInfo) {
                // 实际项目中，这里应该是向服务器发送请求生成支付宝订单
                return new Promise((resolve, reject) => {
                    // 模拟API请求
                    setTimeout(() => {
                        // 模拟成功返回支付链接
                        resolve({
                            status: 'success',
                            qrCodeUrl: 'https://gw.alipayobjects.com/zos/rmsportal/eNlFytEEYPVfPTmEWuXa.png',
                            outTradeNo: orderInfo.orderId
                        });
                    }, 1000);
                });
            }

            /**
             * @description 查询支付状态的函数
             * @param {string} outTradeNo - 商户订单号
             * @returns {Promise} - 返回支付状态的Promise
             */
            function queryAlipayOrderStatus(outTradeNo) {
                // 实际项目中，这里应该是向服务器查询订单状态
                return new Promise((resolve, reject) => {
                    // 模拟API请求
                    setTimeout(() => {
                        // 模拟支付成功
                        resolve({
                            status: 'success',
                            tradeStatus: 'TRADE_SUCCESS'
                        });
                    }, 2000);
                });
            }
            
            // 初始化支付宝支付
            initAlipay();
            
            // 处理支付按钮点击
            document.getElementById('submit-payment').addEventListener('click', function() {
                // 表单验证
                const name = document.getElementById('first-name').value;
                const phone = document.getElementById('phone').value;
                const email = document.getElementById('email').value;
                
                if (!name || !phone) {
                    alert('请填写姓名和手机号码');
                    return;
                }
                
                // 检查选择的支付方式
                const alipaySelected = document.getElementById('payment-alipay').checked;
                const wechatSelected = document.getElementById('payment-wechat').checked;
                const bankSelected = document.getElementById('payment-bank').checked;
                
                if (alipaySelected) {
                    // 获取当前课程信息
                    if(courseId && courses[courseId]) {
                        const courseName = courses[courseId].name;
                        const priceText = courses[courseId].price;
                        
                        // 从价格文本中提取数字部分
                        const priceMatch = priceText.match(/\d+(?:,\d+)?/g);
                        if(priceMatch && priceMatch.length > 0) {
                            const totalAmount = parseFloat(priceMatch[0].replace(',', ''));
                            const orderId = 'ORDER_' + Date.now();
                            
                            // 创建订单信息
                            const orderInfo = {
                                orderId: orderId,
                                subject: courseName,
                                totalAmount: totalAmount.toFixed(2),
                                buyerName: name,
                                buyerPhone: phone,
                                buyerEmail: email
                            };
                            
                            // 显示加载状态
                            const submitBtn = document.getElementById('submit-payment');
                            submitBtn.disabled = true;
                            submitBtn.textContent = '处理中...';
                            
                            // 创建支付宝订单
                            createAlipayOrder(orderInfo).then(result => {
                                // 订单创建成功，更新UI显示二维码
                                const qrcodeDiv = document.getElementById('alipay-qrcode');
                                if(qrcodeDiv) {
                                    qrcodeDiv.innerHTML = `<img src="${result.qrCodeUrl}" alt="支付宝支付二维码" class="w-48 h-48">`;
                                }
                                
                                // 开始轮询支付状态
                                const checkInterval = setInterval(() => {
                                    queryAlipayOrderStatus(result.outTradeNo).then(statusResult => {
                                        if(statusResult.tradeStatus === 'TRADE_SUCCESS') {
                                            // 支付成功
                                            clearInterval(checkInterval);
                                            alert('支付成功！我们将尽快与您联系确认课程详情。');
                                            // 重定向到课程列表页面
                                            window.location.href = 'courses.html';
                                        }
                                    }).catch(err => {
                                        console.error('查询支付状态失败:', err);
                                    });
                                }, 3000); // 每3秒查询一次
                                
                                // 恢复按钮状态
                                submitBtn.disabled = false;
                                submitBtn.textContent = '确认支付';
                            }).catch(err => {
                                console.error('创建支付宝订单失败:', err);
                                alert('创建订单失败，请稍后重试');
                                
                                // 恢复按钮状态
                                submitBtn.disabled = false;
                                submitBtn.textContent = '确认支付';
                            });
                        }
                    }
                } else if (wechatSelected) {
                    // 这里处理微信支付
                    alert('微信支付功能开发中，请稍后尝试');
                } else if (bankSelected) {
                    // 这里处理银行转账
                    alert('银行转账信息已发送到您的邮箱，请查收');
                }
            });

            /**
             * @description 支付宝支付结果同步功能
             */
            function initAlipaySync() {
                // 创建订单数据存储
                const orderStorage = {
                    // 模拟数据库存储订单
                    orders: {},
                    
                    /**
                     * @description 保存订单信息
                     * @param {Object} orderData - 订单数据
                     */
                    saveOrder: function(orderData) {
                        this.orders[orderData.orderId] = {
                            ...orderData,
                            status: 'WAIT_BUYER_PAY',
                            createTime: new Date().toISOString()
                        };
                        // 保存到localStorage以便演示
                        localStorage.setItem('alipayOrders', JSON.stringify(this.orders));
                        console.log('订单已保存:', orderData.orderId);
                    },
                    
                    /**
                     * @description 更新订单状态
                     * @param {string} orderId - 订单ID
                     * @param {string} status - 订单状态
                     */
                    updateOrderStatus: function(orderId, status) {
                        if (this.orders[orderId]) {
                            this.orders[orderId].status = status;
                            this.orders[orderId].updateTime = new Date().toISOString();
                            
                            // 保存到localStorage以便演示
                            localStorage.setItem('alipayOrders', JSON.stringify(this.orders));
                            console.log('订单状态已更新:', orderId, status);
                            
                            // 分发订单状态变更事件
                            const event = new CustomEvent('orderStatusChanged', {
                                detail: {
                                    orderId: orderId,
                                    status: status
                                }
                            });
                            document.dispatchEvent(event);
                            
                            return true;
                        }
                        return false;
                    },
                    
                    /**
                     * @description 获取订单信息
                     * @param {string} orderId - 订单ID
                     * @returns {Object|null} - 订单信息
                     */
                    getOrder: function(orderId) {
                        return this.orders[orderId] || null;
                    },
                    
                    /**
                     * @description 从本地存储恢复订单数据
                     */
                    restoreOrders: function() {
                        const savedOrders = localStorage.getItem('alipayOrders');
                        if (savedOrders) {
                            try {
                                this.orders = JSON.parse(savedOrders);
                                console.log('已恢复订单数据');
                            } catch (e) {
                                console.error('恢复订单数据失败:', e);
                            }
                        }
                    }
                };
                
                // 恢复之前保存的订单
                orderStorage.restoreOrders();
                
                /**
                 * @description 处理支付宝回调
                 * @param {Object} callbackData - 回调数据
                 */
                function handleAlipayCallback(callbackData) {
                    // 实际项目中需要验证签名，确保回调真实性
                    const { out_trade_no, trade_status } = callbackData;
                    
                    // 更新订单状态
                    if (orderStorage.updateOrderStatus(out_trade_no, trade_status)) {
                        // 显示支付结果
                        showPaymentResult(out_trade_no, trade_status);
                        
                        // 如果支付成功，同步到网站其他部分
                        if (trade_status === 'TRADE_SUCCESS') {
                            syncPaymentToWebsite(out_trade_no);
                        }
                    }
                }
                
                /**
                 * @description 显示支付结果
                 * @param {string} orderId - 订单ID
                 * @param {string} status - 支付状态
                 */
                function showPaymentResult(orderId, status) {
                    const order = orderStorage.getOrder(orderId);
                    if (!order) return;
                    
                    // 创建支付结果显示区域
                    let resultHtml = '';
                    let statusClass = '';
                    
                    if (status === 'TRADE_SUCCESS') {
                        statusClass = 'bg-green-100 text-green-800 border-green-200';
                        resultHtml = `
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="font-medium">支付成功</span>
                            </div>
                            <p class="mt-2 text-sm">订单金额: ￥${order.totalAmount}</p>
                            <p class="text-sm">订单编号: ${orderId}</p>
                            <p class="text-sm">支付时间: ${new Date().toLocaleString()}</p>
                        `;
                    } else if (status === 'TRADE_CLOSED') {
                        statusClass = 'bg-red-100 text-red-800 border-red-200';
                        resultHtml = `
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                <span class="font-medium">支付已取消</span>
                            </div>
                            <p class="mt-2 text-sm">订单金额: ￥${order.totalAmount}</p>
                            <p class="text-sm">订单编号: ${orderId}</p>
                        `;
                    } else {
                        statusClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                        resultHtml = `
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="font-medium">等待支付</span>
                            </div>
                            <p class="mt-2 text-sm">订单金额: ￥${order.totalAmount}</p>
                            <p class="text-sm">订单编号: ${orderId}</p>
                            <p class="text-sm">请尽快完成支付</p>
                        `;
                    }
                    
                    // 显示支付结果
                    const resultElement = document.getElementById('payment-result');
                    if (!resultElement) {
                        const container = document.createElement('div');
                        container.id = 'payment-result';
                        container.className = `mt-8 p-4 rounded-lg border ${statusClass}`;
                        container.innerHTML = resultHtml;
                        
                        const mainContent = document.querySelector('main');
                        if (mainContent) {
                            mainContent.appendChild(container);
                            
                            // 滚动到支付结果区域
                            container.scrollIntoView({ behavior: 'smooth' });
                        }
                    } else {
                        resultElement.className = `mt-8 p-4 rounded-lg border ${statusClass}`;
                        resultElement.innerHTML = resultHtml;
                    }
                }
                
                /**
                 * @description 同步支付结果到网站其他部分
                 * @param {string} orderId - 订单ID
                 */
                function syncPaymentToWebsite(orderId) {
                    const order = orderStorage.getOrder(orderId);
                    if (!order) return;
                    
                    // 1. 更新用户账户信息（模拟）
                    updateUserAccountInfo(order);
                    
                    // 2. 更新课程访问权限（模拟）
                    updateCourseAccess(order);
                    
                    // 3. 创建订单记录（模拟）
                    createOrderRecord(order);
                    
                    // 4. 发送课程邀请邮件（模拟）
                    sendCourseInvitation(order);
                    
                    console.log('支付结果已同步到网站', order);
                }
                
                /**
                 * @description 更新用户账户信息（模拟）
                 * @param {Object} order - 订单信息
                 */
                function updateUserAccountInfo(order) {
                    // 实际项目中，这里会调用API更新用户数据库
                    console.log('更新用户账户信息:', order.buyerName, order.subject);
                    
                    // 模拟将用户信息存储到localStorage
                    const userInfo = {
                        name: order.buyerName,
                        phone: order.buyerPhone,
                        email: order.buyerEmail,
                        courses: [order.subject]
                    };
                    
                    let savedUsers = {};
                    try {
                        const usersJson = localStorage.getItem('websiteUsers');
                        if (usersJson) {
                            savedUsers = JSON.parse(usersJson);
                        }
                    } catch (e) {
                        console.error('解析用户数据失败:', e);
                    }
                    
                    // 使用电话号码作为用户ID
                    const userId = order.buyerPhone;
                    
                    if (savedUsers[userId]) {
                        // 如果用户已存在，添加新课程
                        if (!savedUsers[userId].courses.includes(order.subject)) {
                            savedUsers[userId].courses.push(order.subject);
                        }
                    } else {
                        // 新用户
                        savedUsers[userId] = userInfo;
                    }
                    
                    localStorage.setItem('websiteUsers', JSON.stringify(savedUsers));
                }
                
                /**
                 * @description 更新课程访问权限（模拟）
                 * @param {Object} order - 订单信息
                 */
                function updateCourseAccess(order) {
                    // 实际项目中，这里会调用API更新课程权限数据库
                    console.log('更新课程访问权限:', order.buyerPhone, order.subject);
                    
                    // 模拟保存课程访问权限
                    const courseAccess = {
                        userId: order.buyerPhone,
                        courseName: order.subject,
                        accessGranted: true,
                        expiryDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString() // 一年后
                    };
                    
                    let savedAccess = [];
                    try {
                        const accessJson = localStorage.getItem('courseAccess');
                        if (accessJson) {
                            savedAccess = JSON.parse(accessJson);
                        }
                    } catch (e) {
                        console.error('解析课程访问数据失败:', e);
                    }
                    
                    // 添加新的访问记录
                    savedAccess.push(courseAccess);
                    localStorage.setItem('courseAccess', JSON.stringify(savedAccess));
                }
                
                /**
                 * @description 创建订单记录（模拟）
                 * @param {Object} order - 订单信息
                 */
                function createOrderRecord(order) {
                    // 实际项目中，这里会调用API创建订单记录
                    console.log('创建订单记录:', order.orderId);
                    
                    // 模拟保存订单记录
                    const orderRecord = {
                        orderId: order.orderId,
                        userId: order.buyerPhone,
                        courseName: order.subject,
                        amount: order.totalAmount,
                        paymentMethod: 'Alipay',
                        status: 'COMPLETED',
                        createTime: new Date().toISOString()
                    };
                    
                    let savedRecords = [];
                    try {
                        const recordsJson = localStorage.getItem('orderRecords');
                        if (recordsJson) {
                            savedRecords = JSON.parse(recordsJson);
                        }
                    } catch (e) {
                        console.error('解析订单记录失败:', e);
                    }
                    
                    // 添加新的订单记录
                    savedRecords.push(orderRecord);
                    localStorage.setItem('orderRecords', JSON.stringify(savedRecords));
                }
                
                /**
                 * @description 发送课程邀请邮件（模拟）
                 * @param {Object} order - 订单信息
                 */
                function sendCourseInvitation(order) {
                    // 实际项目中，这里会调用邮件发送API
                    console.log('发送课程邀请邮件:', order.buyerEmail, order.subject);
                    
                    // 模拟发送邮件
                    const emailContent = `
                        尊敬的 ${order.buyerName}：
                        
                        感谢您购买"${order.subject}"课程！
                        
                        您的订单信息如下：
                        - 订单号：${order.orderId}
                        - 金额：￥${order.totalAmount}
                        - 下单时间：${new Date().toLocaleString()}
                        
                        课程访问方式：
                        1. 登录网站：https://courses.example.com
                        2. 使用您的手机号码 ${order.buyerPhone} 登录
                        3. 在"我的课程"中访问已购买的课程
                        
                        如有任何问题，请联系我们：
                        - 电话：400-123-4567
                        - 邮箱：support@example.com
                        
                        祝学习愉快！
                        
                        职场人加油站团队
                    `;
                    
                    // 模拟保存邮件记录
                    let emailLogs = [];
                    try {
                        const logsJson = localStorage.getItem('emailLogs');
                        if (logsJson) {
                            emailLogs = JSON.parse(logsJson);
                        }
                    } catch (e) {
                        console.error('解析邮件记录失败:', e);
                    }
                    
                    emailLogs.push({
                        to: order.buyerEmail,
                        subject: `职场人加油站 - ${order.subject} 课程购买成功`,
                        content: emailContent,
                        sentTime: new Date().toISOString()
                    });
                    
                    localStorage.setItem('emailLogs', JSON.stringify(emailLogs));
                }
                
                /**
                 * @description 模拟支付宝支付回调
                 * @param {string} orderId - 订单ID
                 * @param {string} status - 支付状态
                 */
                function simulateAlipayCallback(orderId, status) {
                    // 模拟支付宝回调数据
                    const callbackData = {
                        app_id: '2021000000000000',
                        auth_app_id: '2021000000000000',
                        charset: 'utf-8',
                        method: 'alipay.trade.page.pay.return',
                        out_trade_no: orderId,
                        seller_id: '2088000000000000',
                        timestamp: new Date().toISOString(),
                        total_amount: orderStorage.getOrder(orderId).totalAmount,
                        trade_no: 'T' + Date.now(),
                        trade_status: status,
                        version: '1.0'
                    };
                    
                    // 处理回调
                    handleAlipayCallback(callbackData);
                }
                
                // 监听订单状态变更事件
                document.addEventListener('orderStatusChanged', function(e) {
                    const { orderId, status } = e.detail;
                    console.log('订单状态变更:', orderId, status);
                    
                    // 在页面上更新状态显示
                    const statusElement = document.getElementById('order-status');
                    if (statusElement) {
                        if (status === 'TRADE_SUCCESS') {
                            statusElement.textContent = '支付成功';
                            statusElement.className = 'text-green-600 font-medium';
                        } else if (status === 'TRADE_CLOSED') {
                            statusElement.textContent = '已关闭';
                            statusElement.className = 'text-red-600 font-medium';
                        } else {
                            statusElement.textContent = '处理中';
                            statusElement.className = 'text-yellow-600 font-medium';
                        }
                    }
                });
                
                // 将函数暴露给全局，以便从其他地方调用（仅用于演示）
                window.simulateAlipayCallback = simulateAlipayCallback;
                window.orderStorage = orderStorage;
                
                return {
                    handleCallback: handleAlipayCallback,
                    simulateCallback: simulateAlipayCallback,
                    orderStorage: orderStorage
                };
            }
            
            // 初始化支付宝同步功能
            const alipaySync = initAlipaySync();
            
            /**
             * @description 重写createAlipayOrder函数，整合订单存储
             */
            const originalCreateAlipayOrder = createAlipayOrder;
            createAlipayOrder = function(orderInfo) {
                // 先保存订单
                alipaySync.orderStorage.saveOrder(orderInfo);
                
                // 调用原始函数
                return originalCreateAlipayOrder(orderInfo).then(result => {
                    // 添加自动模拟支付回调（仅用于演示）
                    setTimeout(() => {
                        console.log('模拟支付宝回调 - 支付成功');
                        alipaySync.simulateCallback(orderInfo.orderId, 'TRADE_SUCCESS');
                    }, 5000); // 5秒后模拟支付成功
                    
                    return result;
                });
            };
            
            /**
             * @description 重写queryAlipayOrderStatus函数，整合订单存储
             */
            const originalQueryStatus = queryAlipayOrderStatus;
            queryAlipayOrderStatus = function(outTradeNo) {
                // 从订单存储中获取状态
                const order = alipaySync.orderStorage.getOrder(outTradeNo);
                if (order && order.status === 'TRADE_SUCCESS') {
                    return Promise.resolve({
                        status: 'success',
                        tradeStatus: 'TRADE_SUCCESS'
                    });
                }
                
                // 调用原始函数
                return originalQueryStatus(outTradeNo);
            };
        });
    </script>
</body>
</html> 